<!--
    Targets for working from terminal window:
    build-nomod - build fuji without FOP access modifiers
    build       - build fuji
    clean       - remove all build files
    jar-nomod   - build a runnable jar file (fuji without FOP access modifiers)
    jar         - build a runnable jar file
    

    Targets for working from Eclipse:
    gen             - generates scanner, parser and AST (JastAdd) java files
    genClean        - removes all files generated by gen target
-->
<project name="Fuji" default="build" basedir=".">

  <!-- PROPERTIES -->

  <!-- location of Fuji -->
  <property name="Fuji" value="src"/>
  <!-- location of libraries used by Fuji -->
  <property name="lib" value="lib"/>
  <!-- location of JastAddJ -->
  <property name="JastAddJ" value="${lib}/JastAddJ"/>
  <!-- location of Java1.4Frontend -->
  <property name="Java1.4Frontend" value="${JastAddJ}/Java1.4Frontend"/>
  <!-- location of Java1.4Backend -->
  <property name="Java1.4Backend" value="${JastAddJ}/Java1.4Backend"/>
  <!-- location of Java1.5Frontend -->
  <property name="Java1.5Frontend" value="${JastAddJ}/Java1.5Frontend"/>
  <!-- location of Java1.5Backend -->
  <property name="Java1.5Backend" value="${JastAddJ}/Java1.5Backend"/>
  <!-- location of generators and libraries -->
  <property name="tools" value="${Java1.4Frontend}/tools"/>
  <!-- location to store files generated by JastAdd. NOTE: The same name will be
       used in package declarations in generated java files. -->
  <property name="package" value="AST"/>
  <!-- location of rules and generated scanner files -->
  <property name="scanner" value="${Fuji}/scanner"/>
  <!-- location of grammer and generated JastAddJ parser files -->
  <property name="parser" value="${Fuji}/parser"/>
  <!-- location to store parser generated by beaver -->
  <property name="beaver" value="${Fuji}/beaver"/>
  <!-- location to store build files -->
  <property name="build" value="build"/>
  <!-- location to store the class files -->
  <property name="bin" value="${build}/bin"/>
  <!-- location to store the class files -->
  <property name="copying" value="${bin}"/>

  <!-- TASKS -->

  <!-- ant task for the scanner generator -->
  <taskdef name="jflex" classname="JFlex.anttask.JFlexTask" classpath="${tools}/JFlex.jar"/>
  <!-- ant task for the parser generator -->
  <taskdef name="beaver" classname="beaver.comp.run.AntTask" classpath="${tools}/beaver.jar"/>
  <!-- ant task for JastAdd -->
  <taskdef name="jastadd" classname="jastadd.JastAddTask" classpath="${tools}/jastadd2.jar"/>

  <!-- TARGETS -->

  <!-- build fuji without FOP access modifiers -->
  <target name="build-nomod" description="build fuji without FOP access modifiers (fuji without FOP access modifiers). Run 'ant clean' if you have build fuji with access modifiers before.">
    <defaultexcludes add="FOPModifiers.flex"/>
    <defaultexcludes add="FOPModifiers.parser"/>
    <defaultexcludes add="FOPModifiers.jrag"/>
    <antcall target="build"/> 
  </target>

  <!-- build fuji -->
  <target name="build" depends="gen" description="build fuji (fuji with FOP access modifiers).  Run 'ant clean' if you have build fuji without access modifiers before.">
    <mkdir dir="${bin}"/>
    <javac debug="true" nowarn="true" classpath="${bin}:${lib}/commons-cli-1.2/commons-cli-1.2.jar"
	   srcdir="${Fuji}" destdir="${bin}" includes="**/*.java"
	   excludes="test/**" includeAntRuntime="false" />
  </target>

  <!-- generate compiler source files -->
  <target name="gen" depends="scanner,parser"
		description="generates scanner, parser and AST (JastAdd) java files">
    <!-- create AST node types and weave aspect modules -->
    <jastadd package="${package}" rewrite="true" beaver="true" 
    	novisitcheck="true" noCacheCycle="true" outdir="${basedir}/${Fuji}" 
    	debug="false" refineLegacy="false">
      <fileset dir="${Java1.4Frontend}">
	<include name="**/*.ast"/>
	<include name="**/*.jrag"/>
	<include name="**/*.jadd"/> 
	<exclude name="BytecodeAttributes.jrag"/>
	<exclude name="BytecodeDescriptor.jrag"/>
	<exclude name="BytecodeReader.jrag"/>
      </fileset>
      <fileset dir="${Java1.4Backend}">
	<include name="**/*.ast"/>
	<include name="**/*.jrag"/>
	<include name="**/*.jadd"/>
      </fileset>
      <fileset dir="${Java1.5Frontend}">
	<include name="**/*.ast"/>
	<include name="**/*.jrag"/>
	<include name="**/*.jadd"/>
      </fileset>
      <fileset dir="${Java1.5Backend}">
	<include name="**/*.ast"/>
	<include name="**/*.jrag"/>
	<include name="**/*.jadd"/>
      </fileset>
      <fileset dir="${Fuji}">
	<include name="**/*.ast"/>
	<include name="**/*.jrag"/>
	<include name="**/*.jadd"/>
      </fileset>
    </jastadd>
    <!-- copy beaver library files -->
    <copy todir="${beaver}" preservelastmodified="true">
      <fileset dir="${Java1.4Frontend}/beaver">
	<include name="**/*.java"/>
      </fileset>
    </copy>
  </target>

  <!-- generate scanner -->
  <target name="scanner">
    <mkdir dir="${scanner}"/>
    <!-- compose the scanner rules -->
    <concat destfile="${scanner}/JavaScanner.flex" binary="true" force="false">
      <filelist dir="${Java1.4Frontend}/scanner">
	<file name="preamble.flex"/>
	<file name="macros.flex"/>
      </filelist>
      <filelist dir="${Java1.5Frontend}">
	<file name="java15macros.flex"/>
      </filelist>
      <filelist dir="${Java1.4Frontend}/scanner">
	<file name="rules_preamble.flex"/>
	<file name="WhiteSpace.flex"/>
	<file name="Comments.flex"/>
	<file name="Keywords.flex"/>
      </filelist>
      <fileset dir="${scanner}">
	<include name="FOPModifiers.flex" />
	<include name="AHEAD.flex" />
      </fileset>
      <filelist dir="${Java1.5Frontend}">
	<file name="java15keywords.flex"/>
      </filelist>
      <filelist dir="${Java1.4Frontend}/scanner">
	<file name="Literals.flex"/>
      </filelist>
      <filelist dir="${Java1.5Frontend}">
	<file name="java15literals.flex"/>
      </filelist>
      <filelist dir="${Java1.4Frontend}/scanner">
	<file name="Separators.flex"/>
	<file name="Operators.flex"/>
      </filelist>
      <filelist dir="${Java1.5Frontend}">
	<file name="java15operators.flex"/>
	<file name="java15identifiers.flex"/>
      </filelist>
      <filelist dir="${Java1.4Frontend}/scanner">
	<file name="postamble.flex"/>
      </filelist>
    </concat>
    <!-- generate the scanner -->
    <jflex file="${scanner}/JavaScanner.flex" outdir="${scanner}" nobak="yes"/>
    <copy todir="${scanner}" file="${Java1.4Frontend}/scanner/Unicode.java" preservelastmodified="true"/>
  </target>

  <!-- generate parser -->
  <target name="parser">
    <mkdir dir="${parser}"/>
    <!-- phase 1: create a full .lalr specification from fragments -->
    <concat destfile="${parser}/JavaParser.all" binary="true" force="false">
      <filelist dir="${Java1.4Frontend}">
	<file name="parser/preamble.parser"/>
	<file name="parser/java14.parser"/>
	<file name="parser/errorrecovery.parser"/>
      </filelist>
      <fileset dir="${Java1.5Frontend}">
	<include name="*.parser"/>
      </fileset>
      <fileset dir="${parser}">
	<include name="FOPModifiers.parser"/>
	<include name="AHEAD.parser"/>
      </fileset>
    </concat>
    <!-- phase 2: translating .lalr to .beaver -->
    <java classpath="${tools}/JastAddParser.jar:${tools}/beaver-rt.jar" classname="Main" fork="true">
      <arg line="${parser}/JavaParser.all ${parser}/JavaParser.beaver"/>
    </java>
    <!-- phase 3: translating .beaver to .java -->
    <beaver file="${parser}/JavaParser.beaver" terminalNames="yes" compress="yes" useSwitch="yes"/>
  </target>

  <!-- remove generated source files and .class files -->
  <target name="clean" depends="cleanGen" description="remove all build files">
    <!-- delete all build files recursively -->
    <delete dir="${build}"/>
  </target>

  <!-- remove generated source files and .class files -->
  <target name="cleanGen" description="removes all files generated by gen target">
    <delete dir="${Fuji}/${package}"/>
    <delete dir="${beaver}"/>
    <delete>
      <fileset dir="${scanner}"> 
	<include name="JavaScanner.flex"/>
	<include name="JavaScanner.java"/>
	<include name="Unicode.java"/>
      </fileset>
      <fileset dir="${parser}">
	<include name="JavaParser.java"/>
	<include name="JavaParser.beaver"/>
	<include name="JavaParser.all"/>
      </fileset>
    </delete>
  </target>
	
	<!-- build binaries -->
	<target name="jar" depends="build" description="build a runnable jar file (fuji with FOP access modifiers).  Run 'ant clean' if you have build fuji without access modifiers before.">
		<property name="jarName" value="fuji.jar"/>
		<antcall target="jar-builder"/>
	</target>
	<target name="jar-nomod" depends="build-nomod" description="build a runnable jar file (fuji without FOP access modifiers). Run 'ant clean' if you have build fuji with access modifiers before.">
		<property name="jarName" value="fuji-nomod.jar"/>
		<antcall target="jar-builder"/>
	</target>
  <target name="jar-builder">
    <antcall target="copy-licences"/>
    <jar destfile="${build}/${jarName}" basedir="${bin}" includes="**/*.class" excludes="test/**" manifest="${Fuji}/Manifest">
      <fileset dir="${bin}">
	<include name="**/*.class"/>
	<include name="${copying}"/>
      </fileset>
      <zipfileset includes="**/*.class" src="${lib}/commons-cli-1.2/commons-cli-1.2.jar"/>
    </jar>
  </target>

  <!-- copy licences -->
  <target name="copy-licences">
    <mkdir dir="${copying}"/>
    <copy todir="${copying}">
      <fileset file="${Java1.5Backend}/licences/BSD"/>
      <fileset file="${lib}/commons-cli-1.2/LICENSE.txt"/>
    </copy>
  </target>

</project>
